<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="Multipurpose multilanguage Discord bot with many features for your Discord server, like unlimited and feature rich actions for e.g. customcommands.">
		<meta name="theme-color" content="#ed8721">

		<link rel="alternate" hreflang="de-DE" href="https://tomatenkuchen.eu/dashboard/actions/">
		<link rel="canonical" href="https://tomatenkuchen.eu/dashboard/actions/">
		<link rel="manifest" href="../../manifest.json">

		<title>TomatenKuchen - Actions - Dashboard</title>
		<link href="../../assets/images/icon.ico" rel="shortcut icon" type="image/x-icon">
		<link href="../../assets/images/icon.ico" rel="icon" type="image/x-icon">
		<link href="../../assets/images/apple-icon-120.png" rel="apple-touch-icon" sizes="120x120">
		<link href="../../assets/images/apple-icon-152.png" rel="apple-touch-icon" sizes="152x152">

		<link href="../../assets/style.css" rel="stylesheet" type="text/css">

		<link href="../../assets/toasts.css" rel="stylesheet" type="text/css">
		<script src="../../assets/js/toasts.js"></script>

		<link rel="preconnect" href="https://api.tomatenkuchen.eu">
		<link rel="dns-prefetch" href="https://api.tomatenkuchen.eu">

		<script src="../../assets/js/script.js"></script>
		<script src="../../assets/js/language.js"></script>

		<script src="../../assets/js/sockette.js"></script>
		<script src="../../assets/js/api/transformer_dashboard.js"></script>

		<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@%5E1/index.js" integrity="sha384-K6agUzbeMc1GXMXkIluupxooxm0lI/miwK1KgDxZqBS19dXN9xTv3eEg8qOjpQ2q" crossorigin="anonymous"></script>
		<script src="../../assets/js/emojipicker.js"></script>
		<link href="../../assets/emojipicker.css" rel="stylesheet" type="text/css">

		<script>
			function createDialog(dialog = "create-dialog") {
				document.getElementById("action-name").value = "";
				document.getElementById("action-content").value = "";
				document.getElementById("action-sync-container").setAttribute("hidden", "");

				document.getElementById("integration-create-dialog").removeAttribute("data-edit");
				document.getElementById("integration-about").removeAttribute("hidden");
				document.getElementById("integration-id").value = "";
				document.getElementById("integration-id").removeAttribute("readonly");
				document.getElementById("integration-name").value = "";
				document.getElementById("integration-short").value = "";
				document.getElementById("integration-long").value = "";
				document.getElementById("integration-public").checked = true;
				document.getElementById("integration-public").removeAttribute("readonly");
				document.getElementById("integration-content").value = "";
				document.getElementById("integration-placeholders").value = "";
				document.getElementById("integration-input").value = "";
				document.getElementById("integration-env").value = "";
				openDialog(document.getElementById(dialog));
			}

			let changed = [];
			let hasLoaded = false;
			let hasSavePopup = false;
			function handleChange(id) {
				if (!hasLoaded || !id || id.startsWith("action-") || id.startsWith("integration-")) return;
				if (!changed.includes(id)) changed.push(id);

				if (!hasSavePopup) {
					const params = new URLSearchParams(location.search);
					document.body.insertAdjacentHTML("beforeend",
						"<div class='cookie-container unsaved-container' id='unsaved-container'>" +
						"<h2 translation='unsaved.title'>Unsaved changes</h2>" +
						"<button type='button' onclick='saveActions()' translation='unsaved.save'>Save</button>" +
						"<button type='button' class='red' onclick='connectWS(\"" + encode(params.get("guild")) + "\")' translation='unsaved.revert'>Revert</button>" +
						"</div>"
					);
					fadeIn(document.getElementById("unsaved-container"));
					reloadText();
					hasSavePopup = true;
				}
			}

			let guildName = "";
			let integrations = [];
			function integrationInfo(integrationId) {
				openDialog(document.getElementById("info-dialog"));
				const integration = integrations.find(e => e.id == integrationId);

				document.getElementById("info-container").innerHTML =
					"<h1>Information about <b>" + encode(integration.name) + "</b></h1>" +
					"<h2>" + encode(integration.short) + "</h2><br>" +
					"<p>" + encode(integration.long) + "</p><br>" +
					"<p>ID: <code>" + encode(integrationId) + "</code></p>" +
					"<p>Owner: " + encode(integration.owner) + "</p>" +
					"<p>Public: " + (integration.public ? "✅" : "❌") + "</p>" +
					"<p>Used by: <b>" + encode("" + integration.uses) + "</b></p>" +
					"<p>Trigger: <code>" + encode(integration.trigger) + "</code></p>" +
					"<p>Parser version: <code>" + encode(integration.version) + "</code></p>" +
					"<p>Created: " + new Date(integration.created).toLocaleString() + "</p>" +
					"<p>Last update: " + new Date(integration.lastUpdate).toLocaleString() + "</p>" +
					"<br><textarea class='code' rows='" + (Math.round(integration.content.split("\n").length * 1.2) + 2) + "' readonly>" + encode(integration.content) + "</textarea>" +
					"<br><button type='button' class='createForm' onclick='integrationUse(\"" + integrationId + "\")'>Use integration on <b>" + guildName + "</b></button>";
			}
			function integrationUse(integrationId) {
				document.getElementById("info-dialog").style.display = "none";
				openDialog(document.getElementById("create-dialog"));
				const integration = integrations.find(e => e.id == integrationId);

				document.getElementById("create-title").innerHTML = "Create action from integration <b>" + encode(integration.name) + "</b>";
				document.getElementById("action-name").value = encode(integration.name);
				document.getElementById("action-content").value = integration.content;
				document.getElementById("action-sync-container").removeAttribute("hidden");
				document.getElementById("action-submit").onclick = () => createAction(integrationId);
			}

			function integrationEdit(integrationId) {
				openDialog(document.getElementById("integration-create-dialog"));
				const integration = integrations.find(e => e.id == integrationId);

				document.getElementById("integration-create-dialog").setAttribute("data-edit", "");
				document.getElementById("integration-create-title").innerHTML = "Edit integration <b>" + encode(integration.name) + "</b>";
				document.getElementById("integration-about").setAttribute("hidden", "");
				document.getElementById("integration-id").value = integration.id;
				document.getElementById("integration-id").setAttribute("readonly", "");
				document.getElementById("integration-name").value = integration.name;
				document.getElementById("integration-short").value = integration.short;
				document.getElementById("integration-long").value = integration.long;
				document.getElementById("integration-public").checked = integration.public;
				document.getElementById("integration-public").setAttribute("readonly", "");
				document.getElementById("integration-content").value = integration.content;
				document.getElementById("integration-content").rows = Math.round(integration.content.split("\n").length * 1.2) + 2;
				document.getElementById("integration-placeholders").value = integration.placeholders.join("\n");
				document.getElementById("integration-placeholders").rows = integration.placeholders.length + 2;
				document.getElementById("integration-input").value = integration.input.join("\n");
				document.getElementById("integration-input").rows = integration.input.length + 2;
				document.getElementById("integration-env").value = integration.env.join("\n");
				document.getElementById("integration-env").rows = integration.env.length + 2;
				document.getElementById("integration-submit").innerText = "Edit integration";
			}

			let socket;
			function deleteAction(elem, action) {
				const confirmed = confirm("Are you sure you want to delete this action? This cannot be undone!");
				if (confirmed) {
					elem.parentElement.remove();
					socket.send(JSON.stringify({status: "success", action: "DELETE_action", name: action}));
				}
			}

			let pickerData = {
				"action-trigger": {
					command: "Message and/or slash command used",
					button: "Button pressed",
					select: "Select menu selected",
					automod: "Discord Automod triggered",
					reactionAdd: "Reaction added",
					reactionRemove: "Reaction removed",
					roleAdd: "Role added to user",
					roleRemove: "Role removed from user",
					join: "Member joined",
					leave: "Member left"
				},
				"action-version": {
					"1.0.0": "1.0.0 (current)"
				},
				"action-sync": {
					none: "Disable syncing",
					manual: "Manual syncing, be notified of changes",
					auto: "Auto syncing, changes are instantly applied once updated, content not editable. Your integration? You likely want to use this.",
					safeAuto: "Safe auto syncing, changes are applied after bot or server staff review, content not editable. Not your integration? You likely want to use this."
				}
			};
			function connectWS(guild) {
				socket = sockette("wss://api.tomatenkuchen.eu", {
					onClose: event => {
						errorToast = new ToastNotification({type: "ERROR", title: "Lost connection, retrying...", timeout: 30}).show();

						if (hasSavePopup) {
							fadeOut(document.getElementById("unsaved-container"));
							hasSavePopup = false;
							changed = [];
						}
						hasLoaded = false;
					},
					onOpen: event => {
						console.log("Connected!", event);
						if (errorToast) {
							errorToast.setType("SUCCESS");
							setTimeout(() => {
								errorToast.close();
							}, 1000);
						}
						socket.send({
							status: "success",
							action: "GET_actions",
							guild,
							lang: getLanguage(),
							token: getCookie("token")
						});
						socket.send({
							status: "success",
							action: "GET_emojis",
							guild,
							token: getCookie("token")
						});
					},
					onMessage: event => {
						let json;
						try {
							json = JSON.parse(event.data);
						} catch (e) {
							console.warn(e, event);
							return socket.send({
								status: "error",
								message: "Invalid json",
								debug: event.data
							});
						}
						console.log(json);

						if (json.action == "NOTIFY") new ToastNotification(json).show();
						else if (json.action == "RECEIVE_actions") {
							document.getElementById("linksidebar").innerHTML =
								"<a href='/' title='Home' class='tab'>" +
									"<ion-icon name='home-outline'></ion-icon>" +
									"<p translation='sidebar.home'></p>" +
								"</a>" +
								"<a href='/commands/' title='Bot commands' class='tab'>" +
									"<ion-icon name='terminal-outline'></ion-icon>" +
									"<p translation='sidebar.commands'></p>" +
								"</a>" +
								"<a href='/dashboard/' class='tab active'>" +
									"<ion-icon name='settings-outline'></ion-icon>" +
									"<p translation='sidebar.dashboard'></p>" +
								"</a>" +
								"<div class='section middle'><p class='title' translation='dashboard.settings'></p>" +
									"<a class='tab otherlinks' href='../settings/?guild=" + guild + "'><ion-icon name='settings-outline'></ion-icon><p translation='dashboard.settings'></p></a>" +
									"<div class='tab otherlinks active'><ion-icon name='terminal-outline'></ion-icon><p>Actions</p></div>" +
									"<a class='tab otherlinks' href='../customcommands/?guild=" + guild + "'><ion-icon name='terminal-outline'></ion-icon><p>Customcommands</p></a>" +
									"<a class='tab otherlinks' href='../reactionroles/?guild=" + guild + "'><ion-icon name='happy-outline'></ion-icon><p>Reactionroles</p></a>" +
									"<a class='tab otherlinks' href='../../leaderboard/?guild=" + guild + "'><ion-icon name='speedometer-outline'></ion-icon><p>Leaderboard</p></a>" +
									"<a class='tab otherlinks' href='../../stats/?guild=" + guild + "'><ion-icon name='bar-chart-outline'></ion-icon><p translation='dashboard.stats'></p></a>" +
								"</div></div>";

							document.getElementById("root-container").innerHTML = "<div class='settingsContent'>" + getActionsHTML(json) + "</div>";
							reloadText();
							guildName = json.name;
							integrations = json.integrations;
							for (const elem of document.querySelectorAll("input, textarea")) elem.onchange = () => handleChange(elem.id);
							hasLoaded = true;

							[["action-trigger", "command"], ["action-version", "1.0.0"], ["action-sync", "safeAuto"], ["integration-trigger", "command"], ["integration-version", "1.0.0"]].forEach(item => {
								const elem = document.querySelector("#" + item[0] + " .picker div[data-id='" + item[1] + "']");
								elem.classList.add("selected");
								document.querySelector("#" + item[0] + " .list").innerHTML += "<div>" + elem.innerHTML + "</div>";
								document.getElementById(item[0]).setAttribute("data-selected", elem.getAttribute("data-id"));
							});
						} else if (json.action == "SAVED_actions") {
							saving = false;
							savingToast.setType("SUCCESS").setTitle("Saved actions!");
						} else if (json.action == "RECEIVE_emojis") {
							pickerData = {
								...pickerData,
								emojis: json.emojis,
								roles: json.roles
							};
						}
					}
				});
			}
		</script>
	</head>
	<body class="dark-theme" onload="pageLoad()">
		<global-sidebar page="dashboard"></global-sidebar>

		<main class="main" id="main">
			<header class="top">
				<div class="hamburger" onclick="sidebar()">
					<div class="line" id="lineTop1"></div>
					<div class="line" id="lineBottom1"></div>
				</div>

				<div class="hoverdropdown">
					<div class="account" onclick="location = '/login/'">
						<p id="username-header">Account</p>
						<ion-icon id="username-avatar" name="person-circle-outline"></ion-icon>
					</div>
					<div class="hoverdropdown-content">
						<a href="/login/" translation="global.login"></a>
					</div>
				</div>
			</header>

			<div class="content" id="content">
				<div id="create-dialog" class="dialog">
					<div class="dialog-content">
						<span class="close">&times;</span>
						<h1 id="create-title">Create action</h1>

						<label for="action-name">Name</label>
						<input type="text" maxlength="32" placeholder="Display name, if command: command name" name="action-name" id="action-name">

						<label for="action-trigger">Action trigger</label>
						<channel-picker id="action-trigger" type="action-trigger"></channel-picker>

						<label for="action-slashcommand">If command: Slash command description</label>
						<input type="text" maxlength="100" placeholder="Slash command description" name="action-slashcommand" id="action-slashcommand" title="If the trigger type is command, filling this out will create a slash command for it with the given description. Can be used as comment for non-commands.">

						<label for="action-version">Parser version</label>
						<channel-picker id="action-version" type="action-version"></channel-picker>

						<div id="action-sync-container" hidden>
							<label for="action-sync">Sync mode from original</label>
							<channel-picker id="action-sync" type="action-sync"></channel-picker>
						</div>

						<label for="action-content" translation="dashboard.content"></label>
						<div class="emoji-container emoji-special">
							<textarea class="code" maxlength="2000" placeholder="Action content" name="action-content" id="action-content" rows="8"></textarea>
							<ion-icon name="at-outline" title="Rolepicker" onclick="mentionPicker(this.parentElement, pickerData.roles)"></ion-icon>
							<ion-icon name="happy-outline" title="Emojipicker" onclick="emojiPicker(this.parentElement, pickerData.emojis, guildName)"></ion-icon>
						</div>

						<button type="submit" id="action-submit" class="createForm" onclick="createAction()">Create action</button>
					</div>
				</div>

				<div id="integration-create-dialog" class="dialog">
					<div class="dialog-content">
						<span class="close">&times;</span>
						<h1 id="integration-create-title">Create integration</h1>
						<div id="integration-about">
							<h2>Integrations are actions which can be shared between servers.</h2>
							<h3>If you only want to create a customcommand or other per-server actions, you likely won't need this.</h3>
						</div>

						<label for="integration-id">ID</label>
						<input type="text" maxlength="32" pattern="[a-z0-9_\-]+" placeholder="Unique integration ID" name="integration-id" id="integration-id">

						<label for="integration-name">Name</label>
						<input type="text" maxlength="32" placeholder="Display name, if command: command name" name="integration-name" id="integration-name">

						<label for="integration-short">Short description</label>
						<input type="text" maxlength="200" placeholder="Short description" name="integration-short" id="integration-short">

						<label for="integration-long">Long description</label>
						<textarea class="setting" maxlength="1000" placeholder="Long description" name="integration-long" id="integration-long" rows="7"></textarea>

						<label for="integration-image">Image URL</label>
						<input type="text" maxlength="500" placeholder="Image URL" name="integration-image" id="integration-image">

						<label for="integration-public">Public</label>
						<input type="checkbox" name="integration-public" id="integration-public" checked>

						<label for="integration-trigger">Trigger</label>
						<channel-picker id="integration-trigger" type="action-trigger"></channel-picker>

						<label for="integration-slashcommand">If command: Slash command description</label>
						<input type="text" maxlength="100" placeholder="Slash command description" name="integration-slashcommand" id="integration-slashcommand" title="If the trigger type is command, filling this out will create a slash command for it with the given description. Can be used as comment for non-commands.">

						<label for="integration-version">Parser version</label>
						<channel-picker id="integration-version" type="action-version"></channel-picker>

						<label for="integration-content" translation="dashboard.content"></label>
						<div class="emoji-container emoji-special">
							<textarea class="code" maxlength="2000" placeholder="Integration content" name="integration-content" id="integration-content" rows="10"></textarea>
							<ion-icon name="at-outline" title="Rolepicker" onclick="mentionPicker(this.parentElement, pickerData.roles)"></ion-icon>
							<ion-icon name="happy-outline" title="Emojipicker" onclick="emojiPicker(this.parentElement, pickerData.emojis, guildName)"></ion-icon>
						</div>

						<label for="integration-placeholders">Placeholder text, one per line</label>
						<textarea class="code" maxlength="300" placeholder="Placeholders" name="integration-placeholders" id="integration-placeholders" rows="2"></textarea>

						<label for="integration-input">Input variables, one per line</label>
						<textarea class="code" maxlength="300" placeholder="url;Your GitHub URL;https://github.com/DEVTomatoCake" name="integration-input" id="integration-input" rows="2"></textarea>

						<label for="integration-env">Hidden environment variables, one per line, invisible to users</label>
						<textarea class="code" maxlength="300" placeholder="apikey;your-secret-api-key" name="integration-env" id="integration-env" rows="2"></textarea>

						<button type="submit" id="integration-submit" class="createForm" onclick="createIntegration()">Create integration</button>
					</div>
				</div>

				<div id="info-dialog" class="dialog">
					<div class="dialog-content">
						<span class="close">&times;</span>
						<div id="info-container"></div>
					</div>
				</div>

				<div id="root-container" class="row"></div>
			</div>
		</main>

		<script>
			function createAction(sourceId = "") {
				const name = encode(document.getElementById("action-name").value);
				if (!name) return alert("Enter a name for the action!");
				const content = encode(document.getElementById("action-content").value);
				if (!content) return alert("Enter content for the action!");

				document.getElementById("create-dialog").style.display = "none";
				if (document.getElementById("no-action")) document.getElementById("no-action").remove();

				const div = document.createElement("div");
				div.innerHTML =
					"<div>" +
					"<label for='" + name + "'><b>" + name + "</b></label>" +
					"<div class='emoji-container'>" +
					"<textarea class='code' rows='" + (Math.round(content.split("\n").length * 1.2) + 2) + "' id='" + name + "-action' maxlength='2000' name='" + name + "' data-slashcommand='" +
					encode(document.getElementById("action-slashcommand").value) + "' data-trigger='" + encode(document.getElementById("action-trigger").getAttribute("data-selected")) +
					(sourceId ? "' data-source='" + encode(sourceId) + "' data-sync='" + encode(document.getElementById("action-sync").getAttribute("data-selected")) : "") + "' data-version='" +
					encode(document.getElementById("action-version").getAttribute("data-selected")) + "'>" + content + "</textarea>" +
					"<ion-icon name='at-outline' title='Rolepicker' onclick='mentionPicker(this.parentElement, pickerData.roles)'></ion-icon>" +
					"<ion-icon name='happy-outline' title='Emojipicker' onclick='emojiPicker(this.parentElement, pickerData.emojis, guildName)'></ion-icon>" +
					"</div>" +
					"<ion-icon name='trash-outline' onclick='deleteAction(this, \"" + name + "\");'></ion-icon>" +
					"<br><br></div>";
				document.getElementsByClassName("settingsContent")[0].appendChild(div);
				for (const elem of document.querySelectorAll("input, textarea")) elem.onchange = () => handleChange(elem.id);

				changed.push(name + "-action");
				saveActions();
			}

			const params = new URLSearchParams(location.search);
			let saving = false;
			let savingToast;
			let errorToast;

			function saveActions() {
				if (!params.has("guild") || saving) return;

				saving = true;
				const settings = document.getElementsByClassName("setting");

				const items = {};
				for (let i = 0; i < settings.length; i++) {
					const item = settings.item(i);
					console.warn(changed)
					if (!changed.includes(item.id)) {
						console.warn("Skipping unchanged action " + item.id)
						continue;
					}

					items[item.name] = {
						content: item.value,
						description: item.getAttribute("data-slashcommand") || void 0,
						trigger: item.getAttribute("data-trigger"),
						version: item.getAttribute("data-version") || Object.keys(pickerData["action-version"])[Object.keys(pickerData["action-version"]).length - 1]
					};
				}

				socket.send(JSON.stringify({
					status: "success",
					action: "SAVE_actions",
					data: items
				}));

				if (hasSavePopup) {
					fadeOut(document.getElementById("unsaved-container"));
					hasSavePopup = false;
					changed = [];
				}

				savingToast = new ToastNotification({type: "LOADING", title: "Saving actions...", timeout: 7}).show();
			}

			async function createIntegration() {
				const id = encode(document.getElementById("integration-id").value);
				if (!id) return alert("Enter an id for the integration!");
				const name = encode(document.getElementById("integration-name").value);
				if (!name) return alert("Enter a name for the integration!");
				const content = encode(document.getElementById("integration-content").value);
				if (!content) return alert("Enter content for the integration!");
				const short = encode(document.getElementById("integration-short").value);
				if (!short) return alert("Enter a short description for the integration!");

				document.getElementById("integration-create-dialog").style.display = "none";

				const placeholders = document.getElementById("integration-placeholders").value.split("\n").map(e => e.trim()).filter(e => e);
				const input = document.getElementById("integration-input").value.split("\n").map(e => e.trim()).filter(e => e);
				const env = document.getElementById("integration-env").value.split("\n").map(e => e.trim()).filter(e => e);

				const res = await fetch("https://api.tomatenkuchen.eu/api/integrations?token=" + getCookie("token"), {
					method: "POST",
					headers: {
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						edit: document.getElementById("integration-create-dialog").getAttribute("data-edit"),
						id,
						name,
						content,
						trigger: document.getElementById("integration-trigger").getAttribute("data-selected"),
						version: document.getElementById("integration-version").getAttribute("data-selected"),
						slashcommand: document.getElementById("integration-slashcommand").value,
						short,
						long: document.getElementById("integration-long").value,
						image: document.getElementById("integration-image").value,
						public: document.getElementById("integration-public").checked,
						placeholders,
						input,
						env
					})
				})
				const json = await res.json()
				console.log("Response for POST https://api.tomatenkuchen.eu/api/integrations: " + JSON.stringify(json))
				alert(json.message)
			}

			if (params.has("guild") && getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Loading actions...</h1>";
				connectWS(encode(params.get("guild")));
			} else if (params.has("guild_id") && getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Loading actions...</h1>";
				location.href = "./?guild=" + params.get("guild_id");
			} else if (getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to server selection...</h1>";
				localStorage.setItem("next", location.pathname);
				location.href = "../";
			} else {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to login...</h1>";
				location.href = "../../login/?next=" + encodeURIComponent(location.pathname + location.search);
			}
		</script>

		<global-footer></global-footer>
		<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" integrity="sha384-xyQ/Vpt1cq1pdPYlRaT/QkcSj2vrYyWI3WOhxGBzqnP1vgvsS2yrhWXe3/wIoCr5" crossorigin="anonymous"></script>
	</body>
</html>
