<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="Multipurpose multilanguage Discord bot with many features for your Discord server, like unlimited and feature rich actions for e.g. customcommands.">
		<meta name="theme-color" content="#ed8721">

		<link rel="alternate" hreflang="de-DE" href="https://tomatenkuchen.eu/dashboard/actions/">
		<link rel="canonical" href="https://tomatenkuchen.eu/dashboard/actions/">
		<link rel="manifest" href="../../manifest.json">

		<title>TomatenKuchen - Actions - Dashboard</title>
		<link href="../../assets/images/icon.ico" rel="shortcut icon" type="image/x-icon">
		<link href="../../assets/images/icon.ico" rel="icon" type="image/x-icon">
		<link href="../../assets/images/apple-icon-120.png" rel="apple-touch-icon" sizes="120x120">
		<link href="../../assets/images/apple-icon-152.png" rel="apple-touch-icon" sizes="152x152">

		<link href="../../assets/style.css" rel="stylesheet" type="text/css">

		<link href="../../assets/toasts.css" rel="stylesheet" type="text/css">
		<script src="../../assets/js/toasts.js"></script>

		<link rel="preconnect" href="https://api.tomatenkuchen.eu">
		<link rel="dns-prefetch" href="https://api.tomatenkuchen.eu">

		<script src="../../assets/js/script.js"></script>
		<script src="../../assets/js/language.js"></script>

		<script src="../../assets/js/sockette.js"></script>
		<script src="../../assets/js/api/transformer_dashboard.js"></script>

		<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@%5E1/index.js" integrity="sha384-K6agUzbeMc1GXMXkIluupxooxm0lI/miwK1KgDxZqBS19dXN9xTv3eEg8qOjpQ2q" crossorigin="anonymous"></script>
		<script src="../../assets/js/emojipicker.js"></script>
		<link href="../../assets/emojipicker.css" rel="stylesheet" type="text/css">

		<script>
			function createDialog(dialog = "create-dialog") {
				document.getElementById("action-name").value = "";
				document.getElementById("action-content").value = "";

				document.getElementById("integration-name").value = "";
				document.getElementById("integration-shortdesc").value = "";
				document.getElementById("integration-longdesc").value = "";
				document.getElementById("integration-public").checked = true;
				document.getElementById("integration-content").value = "";
				openDialog(document.getElementById(dialog));
			}

			let changed = [];
			let hasLoaded = false;
			let hasSavePopup = false;
			function handleChange(id) {
				if (!hasLoaded || id.startsWith("action-") || id.startsWith("integration-")) return;
				if (!changed.includes(id)) changed.push(id);

				if (!hasSavePopup) {
					const params = new URLSearchParams(window.location.search);
					document.body.insertAdjacentHTML("beforeend",
						"<div class='cookie-container unsaved-container' id='unsaved-container'>" +
						"<h2 translation='unsaved.title'>Unsaved changes</h2>" +
						"<button type='button' onclick='saveActions()' translation='unsaved.save'>Save</button>" +
						"<button type='button' class='red' onclick='connectWS(\"" + encode(params.get("guild")) + "\")' translation='unsaved.revert'>Revert</button>" +
						"</div>"
					);
					fadeIn(document.getElementById("unsaved-container"));
					reloadText();
					hasSavePopup = true;
				}
			}

			let guildName = "";
			let pickerData = {
				"action-trigger": {
					command: "Message and/or slash command",
					button: "Button pressed",
					select: "Select menu selected",
					reactionAdd: "Reaction added",
					reactionRemove: "Reaction removed",
					roleAdd: "Role added to user",
					roleRemove: "Role removed from user",
					join: "Member joined",
					leave: "Member left",
					voiceJoin: "Member joined voice channel",
					voiceLeave: "Member left voice channel",
					voiceSwitch: "Member switched voice channel"
				},
				"action-version": {
					"1.0.0": "1.0.0 (current)"
				}
			};
			let socket;
			function connectWS(guild) {
				socket = sockette("wss://api.tomatenkuchen.eu", {
					onClose: event => {
						errorToast = new ToastNotification({type: "ERROR", title: "Lost connection, retrying...", timeout: 30}).show();

						if (hasSavePopup) {
							fadeOut(document.getElementById("unsaved-container"));
							hasSavePopup = false;
							changed = [];
						}
						hasLoaded = false;
					},
					onOpen: event => {
						console.log("Connected!", event);
						if (errorToast) {
							errorToast.setType("SUCCESS");
							setTimeout(() => {
								errorToast.close();
							}, 1000);
						}
						socket.send({
							status: "success",
							action: "GET_actions",
							guild,
							lang: getLanguage(),
							token: getCookie("token")
						});
						socket.send({
							status: "success",
							action: "GET_emojis",
							guild,
							token: getCookie("token")
						});
					},
					onMessage: event => {
						let json;
						try {
							json = JSON.parse(event.data);
						} catch (e) {
							console.warn(e, event);
							return socket.send({
								status: "error",
								message: "Invalid json",
								debug: event.data
							});
						}
						console.log(json);

						if (json.action == "NOTIFY") new ToastNotification(json).show();
						else if (json.action == "RECEIVE_actions") {
							document.getElementById("linksidebar").innerHTML =
								"<a href='/' title='Home' class='tab'>" +
									"<ion-icon name='home-outline'></ion-icon>" +
									"<p translation='sidebar.home'></p>" +
								"</a>" +
								"<a href='/commands/' title='Bot commands' class='tab'>" +
									"<ion-icon name='terminal-outline'></ion-icon>" +
									"<p translation='sidebar.commands'></p>" +
								"</a>" +
								"<a href='/dashboard/' class='tab active'>" +
									"<ion-icon name='settings-outline'></ion-icon>" +
									"<p translation='sidebar.dashboard'></p>" +
								"</a>" +
								"<div class='section middle'><p class='title' translation='dashboard.settings'></p>" +
									"<a class='tab otherlinks' href='../settings/?guild=" + guild + "'><ion-icon name='settings-outline'></ion-icon><p translation='dashboard.settings'></p></a>" +
									"<div class='tab otherlinks active'><ion-icon name='terminal-outline'></ion-icon><p>Actions</p></div>" +
									"<a class='tab otherlinks' href='../customcommands/?guild=" + guild + "'><ion-icon name='terminal-outline'></ion-icon><p>Customcommands</p></a>" +
									"<a class='tab otherlinks' href='../reactionroles/?guild=" + guild + "'><ion-icon name='happy-outline'></ion-icon><p>Reactionroles</p></a>" +
									"<a class='tab otherlinks' href='../../leaderboard/?guild=" + guild + "'><ion-icon name='speedometer-outline'></ion-icon><p>Leaderboard</p></a>" +
									"<a class='tab otherlinks' href='../../stats/?guild=" + guild + "'><ion-icon name='bar-chart-outline'></ion-icon><p translation='dashboard.stats'></p></a>" +
								"</div></div>";

							document.getElementById("root-container").innerHTML = "<div class='settingsContent'>" + getActionsHTML(json) + "</div>";
							reloadText();
							guildName = json.name;
							for (const elem of document.querySelectorAll("input.setting, textarea.setting")) elem.onchange = () => handleChange(elem.id);
							hasLoaded = true;

							["#action-trigger .picker div[data-id='command']", "#action-version .picker div[data-id='1.0.0']", "#integration-trigger .picker div[data-id='command']", "#integration-version .picker div[data-id='1.0.0']"].forEach(selector => {
								const elem = document.querySelector(selector);
								elem.classList.add("selected");
								document.querySelector(selector.split(" ")[0] + " .list").innerHTML += "<div>" + elem.innerHTML + "</div>";
								document.getElementById(selector.split(" ")[0].replace("#", "")).setAttribute("data-selected", elem.getAttribute("data-id"));
							});
						} else if (json.action == "SAVED_actions") {
							saving = false;
							savingToast.setType("SUCCESS").setTitle("Saved actions!");
						} else if (json.action == "RECEIVE_emojis") {
							pickerData = {
								...pickerData,
								emojis: json.emojis,
								roles: json.roles
							};
						}
					}
				});
			}
		</script>
	</head>
	<body class="dark-theme" onload="pageLoad()">
		<global-sidebar page="dashboard"></global-sidebar>

		<main class="main" id="main">
			<header class="top">
				<div class="hamburger" onclick="sidebar()">
					<div class="line" id="lineTop1"></div>
					<div class="line" id="lineBottom1"></div>
				</div>

				<div class="hoverdropdown">
					<div class="account" onclick="redirect('/login/')">
						<p id="username-header">Account</p>
						<ion-icon id="username-avatar" name="person-circle-outline"></ion-icon>
					</div>
					<div class="hoverdropdown-content">
						<a href="/login/" translation="global.login"></a>
					</div>
				</div>
			</header>

			<div class="content" id="content">
				<div id="create-dialog" class="dialog">
					<div class="dialog-content">
						<span class="close">&times;</span>
						<h1>Create action</h1>

						<label for="action-name">Name</label>
						<input type="text" maxlength="32" placeholder="Action name" name="action-name" id="action-name">

						<label for="action-trigger">Action trigger</label>
						<channel-picker id="action-trigger" type="action-trigger"></channel-picker>

						<label for="action-slashcommand">If command: Slash command description</label>
						<input type="text" maxlength="100" placeholder="Slash command description" name="action-slashcommand" id="action-slashcommand" title="If the trigger type is command, filling this out will create a slash command for it with the given description. Can be used as comment for non-commands.">

						<label for="action-version">Parser version</label>
						<channel-picker id="action-version" type="action-version"></channel-picker>

						<label for="action-content" translation="dashboard.content"></label>
						<div class="emoji-container emoji-special">
							<textarea maxlength="2000" placeholder="Action content" name="action-content" id="action-content" rows="8"></textarea>
							<ion-icon name="at-outline" title="Rolepicker" onclick="mentionPicker(this.parentElement, pickerData.roles)"></ion-icon>
							<ion-icon name="happy-outline" title="Emojipicker" onclick="emojiPicker(this.parentElement, pickerData.emojis, guildName)"></ion-icon>
						</div>

						<button type="submit" class="createForm" onclick="createAction()">Create action</button>
					</div>
				</div>

				<div id="integration-create-dialog" class="dialog">
					<div class="dialog-content">
						<span class="close">&times;</span>
						<h1>Create integration</h1>
						<h2>Integrations are actions which can be shared between servers.</h2>
						<h3>If you only want to create a customcommand or other per-server actions, you likely won't need this.</h3>

						<label for="integration-id">ID</label>
						<input type="text" maxlength="32" placeholder="Unique integration ID" name="integration-id" id="integration-id">

						<label for="integration-name">Name</label>
						<input type="text" maxlength="32" placeholder="Integration name" name="integration-name" id="integration-name">

						<label for="integration-shortdesc">Short description</label>
						<input type="text" maxlength="200" placeholder="Short description" name="integration-shortdesc" id="integration-shortdesc">

						<label for="integration-longdesc">Long description</label>
						<textarea class="setting" maxlength="1000" placeholder="Long description" name="integration-longdesc" id="integration-longdesc" rows="7"></textarea>

						<label for="integration-image">Image URL</label>
						<input type="text" maxlength="500" placeholder="Image URL" name="integration-image" id="integration-image">

						<label for="integration-public">Public</label>
						<input type="checkbox" name="integration-public" id="integration-public" checked>

						<label for="integration-trigger">Trigger</label>
						<channel-picker id="integration-trigger" type="action-trigger"></channel-picker>

						<label for="integration-slashcommand">If command: Slash command description</label>
						<input type="text" maxlength="100" placeholder="Slash command description" name="integration-slashcommand" id="integration-slashcommand" title="If the trigger type is command, filling this out will create a slash command for it with the given description. Can be used as comment for non-commands.">

						<label for="integration-version">Parser version</label>
						<channel-picker id="integration-version" type="action-version"></channel-picker>

						<label for="integration-content" translation="dashboard.content"></label>
						<div class="emoji-container emoji-special">
							<textarea maxlength="2000" placeholder="Integration content" name="integration-content" id="integration-content" rows="10"></textarea>
							<ion-icon name="at-outline" title="Rolepicker" onclick="mentionPicker(this.parentElement, pickerData.roles)"></ion-icon>
							<ion-icon name="happy-outline" title="Emojipicker" onclick="emojiPicker(this.parentElement, pickerData.emojis, guildName)"></ion-icon>
						</div>

						<label for="integration-placeholders">Placeholder text, one per line</label>
						<textarea class="setting" maxlength="300" placeholder="Placeholders" name="integration-placeholders" id="integration-placeholders" rows="2"></textarea>

						<label for="integration-input">Input variables, one per line</label>
						<textarea class="setting" maxlength="300" placeholder="Input variables" name="integration-input" id="integration-input" rows="2"></textarea>

						<label for="integration-env">Environment variables, one per line</label>
						<textarea class="setting" maxlength="300" placeholder="Hidden environment variables" name="integration-env" id="integration-env" rows="2"></textarea>

						<button type="submit" class="createForm" onclick="createIntegration()">Create integration</button>
					</div>
				</div>

				<div id="root-container" class="row"></div>
			</div>
		</main>

		<script>
			function createAction() {
				const name = encode(document.getElementById("action-name").value);
				if (!name) return alert("Enter a name for the action!");
				const content = encode(document.getElementById("action-content").value);
				if (!content) return alert("Enter content for the action!");

				document.getElementById("create-dialog").style.display = "none";
				if (document.getElementById("no-action")) document.getElementById("no-action").remove();

				const div = document.createElement("div");
				div.innerHTML =
					"<label for='" + name + "'><b>" + name + "</b></label>" +
					"<div class='emoji-container'>" +
					"<textarea class='setting' rows='" + (Math.round(content.split("\n").length * 1.2) + 2) + "' id='" + name + "-action' maxlength='2000' name='" + name + "' data-slashcommand='" +
					encode(document.getElementById("action-slashcommand").value) + "' data-trigger='" + encode(document.getElementById("action-trigger").getAttribute("data-selected")) + "' data-version='" +
					encode(document.getElementById("action-version").getAttribute("data-selected")) + "'>" + content + "</textarea>" +
					"<ion-icon name='at-outline' title='Rolepicker' onclick='mentionPicker(this.parentElement, pickerData.roles)'></ion-icon>" +
					"<ion-icon name='happy-outline' title='Emojipicker' onclick='emojiPicker(this.parentElement, pickerData.emojis, guildName)'></ion-icon>" +
					"</div>" +
					"<br>";
				document.getElementsByClassName("settingsContent")[0].appendChild(div);

				changed.push(name + "-action");
				for (const elem of document.querySelectorAll("input.setting, textarea.setting")) elem.onchange = () => handleChange(elem.id);
				saveActions();
			}

			const params = new URLSearchParams(window.location.search);
			let saving = false;
			let savingToast;
			let errorToast;

			function saveActions() {
				if (!params.has("guild") || saving) return;

				saving = true;
				const settings = document.getElementsByClassName("setting");

				const items = {};
				for (let i = 0; i < settings.length; i++) {
					const item = settings.item(i);
					if (!changed.includes(item.id)) continue;

					items[item.name] = {
						content: item.value,
						description: item.getAttribute("data-slashcommand") || void 0,
						trigger: item.getAttribute("data-trigger"),
						version: item.getAttribute("data-version") || Object.keys(pickerData["action-version"])[Object.keys(pickerData["action-version"]).length - 1]
					};
				}

				socket.send(JSON.stringify({
					status: "success",
					action: "SAVE_actions",
					data: items
				}));

				if (hasSavePopup) {
					fadeOut(document.getElementById("unsaved-container"));
					hasSavePopup = false;
					changed = [];
				}

				savingToast = new ToastNotification({type: "LOADING", title: "Saving actions...", timeout: 7}).show();
			}

			async function createIntegration() {
				const id = encode(document.getElementById("integration-id").value);
				if (!id) return alert("Enter an id for the integration!");
				const name = encode(document.getElementById("integration-name").value);
				if (!name) return alert("Enter a name for the integration!");
				const content = encode(document.getElementById("integration-content").value);
				if (!content) return alert("Enter content for the integration!");

				document.getElementById("create-dialog").style.display = "none";

				const placeholders = {}
				document.getElementById("integration-placeholders").value.split("\n").map(e => e.trim()).filter(e => e).forEach(e => placeholders[e.split(":")[0]] = e.split(":").slice(1).join(":").trim());
				const input = {}
				document.getElementById("integration-input").value.split("\n").map(e => e.trim()).filter(e => e).forEach(e => input[e.split(":")[0]] = e.split(":").slice(1).join(":").trim());
				const env = {}
				document.getElementById("integration-env").value.split("\n").map(e => e.trim()).filter(e => e).forEach(e => env[e.split(":")[0]] = e.split(":").slice(1).join(":").trim());

				const res = await fetch("https://api.tomatenkuchen.eu/api/integrations?token=" + getCookie("token"), {
					method: "POST",
					body: JSON.stringify({
						id,
						name,
						content,
						trigger: document.getElementById("integration-trigger").getAttribute("data-selected"),
						version: document.getElementById("integration-version").getAttribute("data-selected"),
						slashcommand: document.getElementById("integration-slashcommand").value,
						shortdesc: document.getElementById("integration-shortdesc").value,
						longdesc: document.getElementById("integration-longdesc").value,
						image: document.getElementById("integration-image").value,
						public: document.getElementById("integration-public").checked,
						placeholders,
						input,
						env
					})
				})
				const json = await res.json()
				console.log("Response for POST https://api.tomatenkuchen.eu/api/integrations: " + JSON.stringify(json))
				alert(json.message)
			}

			if (params.has("guild") && getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Loading actions...</h1>";
				connectWS(encode(params.get("guild")));
			} else if (params.has("guild_id") && getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Loading actions...</h1>";
				location.href = "./?guild=" + params.get("guild_id");
			} else if (getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to server selection...</h1>";
				localStorage.setItem("next", location.pathname);
				location.href = "../";
			} else {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to login...</h1>";
				location.href = "../../login/?next=" + encodeURIComponent(location.pathname + location.search);
			}
		</script>

		<global-footer></global-footer>
		<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" integrity="sha384-xyQ/Vpt1cq1pdPYlRaT/QkcSj2vrYyWI3WOhxGBzqnP1vgvsS2yrhWXe3/wIoCr5" crossorigin="anonymous"></script>
	</body>
</html>
