<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="Multipurpose multilanguage Discord bot with many features for your Discord server, like unlimited and feature rich actions for e.g. customcommands.">
		<meta name="theme-color" content="#ed8721">

		<link rel="alternate" hreflang="de-DE" href="https://tomatenkuchen.eu/dashboard/actions/">
		<link rel="canonical" href="https://tomatenkuchen.eu/dashboard/actions/">
		<link rel="manifest" href="../../manifest.json">

		<title>TomatenKuchen - Actions - Dashboard</title>
		<link href="../../assets/images/icon.ico" rel="shortcut icon" type="image/x-icon">
		<link href="../../assets/images/icon.ico" rel="icon" type="image/x-icon">
		<link href="../../assets/images/apple-icon-120.png" rel="apple-touch-icon" sizes="120x120">
		<link href="../../assets/images/apple-icon-152.png" rel="apple-touch-icon" sizes="152x152">

		<link href="../../assets/style.css" rel="stylesheet" type="text/css">

		<link href="../../assets/toasts.css" rel="stylesheet" type="text/css">
		<script src="../../assets/js/toasts.js"></script>

		<link rel="preconnect" href="https://api.tomatenkuchen.eu">
		<link rel="dns-prefetch" href="https://api.tomatenkuchen.eu">

		<script src="../../assets/js/script.js"></script>
		<script src="../../assets/js/language.js"></script>

		<script src="../../assets/js/sockette.js"></script>
		<script src="../../assets/js/api/transformer_dashboard.js"></script>

		<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@%5E1/index.js" integrity="sha384-K6agUzbeMc1GXMXkIluupxooxm0lI/miwK1KgDxZqBS19dXN9xTv3eEg8qOjpQ2q" crossorigin="anonymous"></script>
		<script src="../../assets/js/emojipicker.js"></script>
		<link href="../../assets/emojipicker.css" rel="stylesheet" type="text/css">

		<script>
			function openDialog(dialog = "create-dialog") {
				document.getElementById("action-name").value = "";
				openDialog(document.getElementById(dialog));
			}

			let guildName = "";
			let actions = [];
			let pickerData = {
				"action-trigger": {
					command: "Message and/or slash command",
					reactionAdd: "Reaction added",
					reactionRemove: "Reaction removed",
					join: "Member joined",
					leave: "Member left",
					voiceJoin: "Member joined voice channel",
					voiceLeave: "Member left voice channel"
				},
				"action-version": {
					"1.0.0": "1.0.0 (current)"
				}
			};
			let socket;
			function connectWS(guild) {
				socket = sockette("wss://api.tomatenkuchen.eu", {
					onClose: event => {
						errorToast = new ToastNotification({type: "ERROR", title: "Lost connection, retrying...", timeout: 30}).show();
					},
					onOpen: event => {
						console.log("Connected!", event);
						if (errorToast) {
							errorToast.setType("SUCCESS");
							setTimeout(() => {
								errorToast.close();
							}, 1000);
						}
						socket.send({
							status: "success",
							action: "GET_actions",
							guild,
							lang: getLanguage(),
							token: getCookie("token")
						});
						socket.send({
							status: "success",
							action: "GET_emojis",
							guild,
							token: getCookie("token")
						});
					},
					onMessage: event => {
						let json;
						try {
							json = JSON.parse(event.data);
						} catch (e) {
							console.warn(e, event);
							return socket.send({
								status: "error",
								message: "Invalid json",
								debug: event.data
							});
						}
						console.log(json);

						if (json.action == "NOTIFY") new ToastNotification(json).show();
						else if (json.action == "RECEIVE_actions") {
							document.getElementById("linksidebar").innerHTML +=
								"<div class='section middle'><p class='title' translation='dashboard.settings'></p>" +
								"<div class='tab otherlinks' onclick='redirect(\"../settings/?guild=" + guild + "\")'><ion-icon name='settings-outline'></ion-icon><p translation='dashboard.settings'></p></div>" +
								"<div class='tab otherlinks active'><ion-icon name='terminal-outline'></ion-icon><p>Actions</p></div>" +
								"<div class='tab otherlinks' onclick='redirect(\"../customcommands/?guild=" + guild + "\")'><ion-icon name='terminal-outline'></ion-icon><p>Customcommands</p></div>" +
								"<div class='tab otherlinks' onclick='redirect(\"../reactionroles/?guild=" + guild + "\")'><ion-icon name='happy-outline'></ion-icon><p>Reactionroles</p></div>" +
								"<div class='tab otherlinks' onclick='redirect(\"../../leaderboard/?guild=" + guild + "\")'><ion-icon name='speedometer-outline'></ion-icon><p>Leaderboard</p></div>" +
								"<div class='tab otherlinks' onclick='redirect(\"../../stats/?guild=" + guild + "\")'><ion-icon name='bar-chart-outline'></ion-icon><p translation='dashboard.stats'></p></div>" +
								"</div>";

							document.getElementById("root-container").innerHTML = "<div class='settingsContent'>" + getActionsHTML(json) + "</div>";
							reloadText();
							guildName = json.name;
							actions = json.data;
						} else if (json.action == "SAVED_actions") {
							saving = false;
							savingToast.setType("SUCCESS").setTitle("Saved actions!");
						} else if (json.action == "RECEIVE_emojis") {
							pickerData = {
								emojis: json.emojis,
								roles: json.roles
							};
						}
					}
				});
			}
		</script>
	</head>
	<body class="dark-theme" onload="pageLoad()">
		<global-sidebar page="dashboard"></global-sidebar>

		<main class="main" id="main">
			<header class="top">
				<div class="hamburger" onclick="sidebar()">
					<div class="line" id="lineTop1"></div>
					<div class="line" id="lineBottom1"></div>
				</div>

				<div class="hoverdropdown">
					<div class="account" onclick="redirect('/login/')">
						<p id="username-header">Account</p>
						<ion-icon id="username-avatar" name="person-circle-outline"></ion-icon>
					</div>
					<div class="hoverdropdown-content">
						<a href="/login/" translation="global.login"></a>
					</div>
				</div>
			</header>

			<div class="content" id="content">
				<div id="create-dialog" class="dialog">
					<span class="close">&times;</span>
					<h1>Create action</h1>

					<label for="action-name">Name</label>
					<input type="text" placeholder="Action name" name="action-name" id="action-name">

					<label for="action-trigger">Action trigger</label>
					<channel-picker id="action-trigger" type="action-trigger"></channel-picker>

					<label for="action-slashcommand">If trigger = command: If filled, registers slash command with this description</label>
					<input type="text" maxlength="100" placeholder="Slash command description" name="action-slashcommand" id="action-slashcommand">

					<label for="action-version">Parser version</label>
					<channel-picker id="action-version" type="action-version"></channel-picker>

					<label for="action-content" translation="dashboard.content"></label>
					<div class="emoji-container" id="newmsg">
						<textarea maxlength="2000" placeholder="Action content" name="action-content" id="action-content" rows="8"></textarea>
						<ion-icon name="at-outline" title="Rolepicker" onclick="mentionPicker(this.parentElement, pickerData.roles)"></ion-icon>
						<ion-icon name="happy-outline" title="Emojipicker" onclick="emojiPicker(this.parentElement, pickerData.emojis, guildName)"></ion-icon>
					</div>

					<br>
					<button type="submit" onclick="createAction()">Create action</button>
				</div>

				<div id="integration-create-dialog" class="dialog">
					<span class="close">&times;</span>
					<h1>Create integration</h1>

					<label for="integration-name">Name</label>
					<input type="text" maxlength="20" placeholder="Integration name" name="integration-name" id="integration-name">

					<label for="integration-shortdesc">Short description</label>
					<input type="text" maxlength="200" placeholder="Integration short description" name="integration-shortdesc" id="integration-shortdesc">

					<label for="integration-longdesc">Long description</label>
					<textarea maxlength="1000" placeholder="Integration long description" name="integration-longdesc" id="integration-longdesc" rows="10"></textarea>

					<label for="integration-public">Public</label>
					<input type="checkbox" name="integration-public" id="integration-public" checked>

					<label for="integration-trigger">Trigger</label>
					<channel-picker id="integration-trigger" type="action-trigger"></channel-picker>

					<label for="integration-slashcommand">If trigger = command: If filled, registers slash command with this description</label>
					<input type="text" maxlength="100" placeholder="Integration slash command description" name="integration-slashcommand" id="integration-slashcommand">

					<label for="integration-version">Parser version</label>
					<channel-picker id="integration-version" type="action-version"></channel-picker>

					<label for="integration-content" translation="dashboard.content"></label>
					<div class="emoji-container" id="newmsg">
						<textarea maxlength="2000" placeholder="Integration content" name="integration-content" id="integration-content" rows="10"></textarea>
						<ion-icon name="at-outline" title="Rolepicker" onclick="mentionPicker(this.parentElement, pickerData.roles)"></ion-icon>
						<ion-icon name="happy-outline" title="Emojipicker" onclick="emojiPicker(this.parentElement, pickerData.emojis, guildName)"></ion-icon>
					</div>

					<br>
					<button type="submit" onclick="createIntegration()">Create integration</button>
				</div>

				<div id="root-container" class="row"></div>
			</div>
		</main>

		<script>
			function createAction() {
				document.getElementById("create-dialog").style.display = "none";
				if (document.getElementById("no-cc")) document.getElementById("no-cc").remove();

				const name = encode(document.getElementById("action-name").value);
				const value = encode(document.getElementById("action-content").value);
				const desc = encode(document.getElementById("action-desc").value);

				const div = document.createElement("div");
				div.innerHTML =
					"<label><b for='" + name + "'>" + name + "</b></label>" +
					"<div class='emoji-container'>" +
					"<textarea class='setting' rows='" + (Math.round(value.split("\n").length * 1.2) + 2) + "' id='" + name + "' maxlength='2000' data-desc='" + desc + "' name='" + name + "'>" + value + "</textarea>" +
					"<ion-icon name='at-outline' title='Rolepicker' onclick='mentionPicker(this.parentElement, pickerData.roles)'></ion-icon>" +
					"<ion-icon name='happy-outline' title='Emojipicker' onclick='emojiPicker(this.parentElement, pickerData.emojis, guildName)'></ion-icon>" +
					"</div>" +
					"<br>";
				document.getElementsByClassName("settingsContent")[0].appendChild(div);
				saveActions();
			};

			const params = new URLSearchParams(window.location.search);
			let saving = false;
			let savingToast;
			let errorToast;

			function saveActions() {
				if (!params.has("guild") || saving) return;

				saving = true;
				const settings = document.getElementsByClassName("setting");

				const items = {};
				for (let i = 0; i < settings.length; i++) {
					const item = settings.item(i);
					items[item.name] = {
						content: item.value,
						description: item.getAttribute("data-slashcommand"),
						version: item.getAttribute("data-version")
					};
				}

				socket.send(JSON.stringify({
					status: "success",
					action: "SAVE_actions",
					data: items
				}));

				savingToast = new ToastNotification({type: "LOADING", title: "Saving actions...", timeout: 5}).show();
			}

			if (params.has("guild") && getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Loading actions...</h1>";
				connectWS(encode(params.get("guild")));
			} else if (params.has("guild_id") && getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Loading actions...</h1>";
				location.href = "./?guild=" + params.get("guild_id");
			} else if (getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to server selection...</h1>";
				localStorage.setItem("next", location.pathname);
				location.href = "../";
			} else {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to login...</h1>";
				location.href = "../../login/?next=" + encodeURIComponent(location.pathname + location.search);
			}
		</script>

		<global-footer></global-footer>
		<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" integrity="sha384-xyQ/Vpt1cq1pdPYlRaT/QkcSj2vrYyWI3WOhxGBzqnP1vgvsS2yrhWXe3/wIoCr5" crossorigin="anonymous"></script>
	</body>
</html>
