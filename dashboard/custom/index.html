<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="Multipurpose multilanguage Discord bot with many features for your Discord server. View your custom branded bots here.">
		<meta name="theme-color" content="#ed8721">

		<link rel="alternate" hreflang="de-DE" href="https://tomatenkuchen.eu/dashboard/custom/">
		<link rel="canonical" href="https://tomatenkuchen.eu/dashboard/custom/">
		<link rel="manifest" href="../../manifest.json">

		<title>TomatenKuchen - Custom branded bots - Dashboard</title>
		<link href="../../assets/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
		<link href="../../assets/images/apple-icon-120.png" rel="apple-touch-icon" sizes="120x120">
		<link href="../../assets/images/apple-icon-152.png" rel="apple-touch-icon" sizes="152x152">

		<link href="../../assets/style.css" rel="stylesheet" type="text/css">

		<link rel="preconnect" href="https://api.tomatenkuchen.eu">
		<link rel="dns-prefetch" href="https://api.tomatenkuchen.eu">

		<script src="../../assets/js/script.js"></script>
		<script src="../../assets/js/language.js"></script>

		<script src="../../assets/js/api/api.js"></script>
		<script src="../../assets/js/api/transformer_dashboard.js"></script>
	</head>
	<body class="dark-theme" onload="pageLoad()">
		<global-sidebar page="dashboard"></global-sidebar>

		<main class="main" id="main">
			<header class="top">
				<div class="hamburger" onclick="sidebar()">
					<div class="line" id="lineTop1"></div>
					<div class="line" id="lineBottom1"></div>
				</div>

				<div class="hoverdropdown">
					<div class="account" onclick="location='/login'">
						<p id="username-header" translation="global.account">Account</p>
						<ion-icon id="username-avatar" name="person-circle-outline"></ion-icon>
					</div>
					<div class="hoverdropdown-content">
						<a href="/login" translation="global.login"></a>
					</div>
				</div>
			</header>

			<div class="content" id="content">
				<div id="create-dialog" class="dialog">
					<div class="dialog-content">
						<span class="close">&times;</span>
						<h1>Create a new custom branded bot</h1>

						<div id="bot-data" class="custom" hidden>
							<br>
							<div class="flex">
								<img id="bot-avatar" width="128" height="128" alt="Bot avatar">
								<h2 id="bot-name"></h2>
							</div>
						</div>

						<div id="step1">
							<label for="custom-token">Your bot token</label>
							<input type="text" minlength="45" maxlength="90" pattern="[a-z0-9]{20,}\.[a-z0-9]{5,}\.[a-z0-9]{25,}" placeholder="Bot token from Discord" oninput="tokenInput()" onchange="tokenChange()" name="custom-token" id="custom-token">
						</div>

						<div id="step2" hidden>
							<h2>Confirm users who have access to the bot</h2>
							<p>The following users have access to the bot and can manage it anytime in the Discord developer dashboard or on this page.</p>
							<p id="bot-access"></p>
						</div>

						<div id="step3" hidden>
							<h2>Select users who pay for the bot</h2>
							<p>
								A list of users who invest their vote credits into this custom bot. This setting allows you to allow your servers members to also vote for the bot to maintain it
								without giving them access to the bot in the dashboard. Every time a "payment" is due, the bot will <b>randomly</b> select a user from this list who has enough credits.
								If none of them has enough, the bot will send a warning and disable itself some time later (TBD).
							</p>
							<label for="custom-invite">Invite users to "pay" for the bot</label>
							<input placeholder="User IDs separated by ," name="custom-invite" id="custom-invite">
						</div>

						<div id="step4" hidden>
							<h2>Remaining TODO list</h2>
							<p id="todo"></p>
						</div>

						<div id="step5" hidden>
							<h2>Create the bot</h2>
							<button type="submit" class="createForm green">Create</button>
						</div>

						<br>
						<button type="button" id="back-button" class="createForm" onclick="back()" hidden>Back</button>
						<button type="button" id="forward-button" class="createForm green" onclick="forward()" disabled>Next</button>
					</div>
				</div>

				<div id="root-container" class="row">
					<h1>Loading your custom branded bots...</h1>
				</div>
			</div>
		</main>

		<script>
			const tokenElem = document.getElementById("custom-token");
			let info = {};
			let step = 1;

			function tokenInput() {
				step = 1;
				document.getElementById("bot-data").setAttribute("hidden", "");
				document.getElementById("back-button").setAttribute("hidden", "");
				document.getElementById("forward-button").setAttribute("disabled", "");

				const value = tokenElem.value;
				if (!value || value.length < 45 || value.length > 90 || value.split(".").length != 3) tokenElem.setCustomValidity("Invalid bot token format.");
				else tokenElem.setCustomValidity("");
				tokenElem.reportValidity();
			}

			async function tokenChange() {
				const value = tokenElem.value;
				if (!value || value.length < 45 || value.length > 90 || value.split(".").length != 3) return;

				info = await getCustomInfo(value);
				if (info.status == "success") {
					document.getElementById("bot-data").removeAttribute("hidden");
					document.getElementById("forward-button").removeAttribute("disabled");

					document.getElementById("bot-name").textContent = encode(info.username);
					document.getElementById("bot-avatar").src = encode(info.avatar) + "?size=128";
					document.getElementById("bot-access").innerHTML = "Users with access:<br><ul>" + info.access.map(user =>
						"<li><img src='" + user.avatar + "?size=64' width='64' height='64' alt='User avatar of " + encode(user.username) + "'>" + encode(user.username) + "</li>"
					).join("") + "</ul>";
				} else {
					tokenElem.setCustomValidity("Invalid bot token.");
					tokenElem.reportValidity();
				}
			}

			function back() {
				if (step <= 1) return;
				document.getElementById("step" + step).setAttribute("hidden", "");
				step--;
				document.getElementById("step" + step).removeAttribute("hidden");

				if (step == 1) document.getElementById("back-button").setAttribute("hidden", "");
				document.getElementById("forward-button").removeAttribute("hidden");
			}
			function forward() {
				document.getElementById("step" + step).setAttribute("hidden", "");
				step++;
				document.getElementById("step" + step).removeAttribute("hidden");

				if (step == 5) document.getElementById("forward-button").setAttribute("hidden", "");
				document.getElementById("back-button").removeAttribute("hidden");
			}

			if (getCookie("token"))
				getCustomHTML().then(data => {
					document.getElementById("root-container").innerHTML = data;
					reloadText();
				});
			else {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to login...</h1>";
				location.href = "../../login/?next=" + encodeURIComponent(location.pathname + location.search);
			}
		</script>

		<global-footer></global-footer>
		<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" integrity="sha384-xyQ/Vpt1cq1pdPYlRaT/QkcSj2vrYyWI3WOhxGBzqnP1vgvsS2yrhWXe3/wIoCr5" crossorigin="anonymous"></script>
	</body>
</html>
