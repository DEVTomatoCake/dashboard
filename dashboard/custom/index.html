<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="Multipurpose multilanguage Discord bot with many features for your Discord server. View your custom branded bots here.">
		<meta name="theme-color" content="#ed8721">

		<link rel="alternate" hreflang="de-DE" href="https://tomatenkuchen.eu/dashboard/custom/">
		<link rel="canonical" href="https://tomatenkuchen.eu/dashboard/custom/">
		<link rel="manifest" href="../../manifest.json">

		<title>TomatenKuchen - Custom branded bots - Dashboard</title>
		<link href="../../assets/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
		<link href="../../assets/images/apple-icon-120.png" rel="apple-touch-icon" sizes="120x120">
		<link href="../../assets/images/apple-icon-152.png" rel="apple-touch-icon" sizes="152x152">

		<link href="../../assets/style.css" rel="stylesheet" type="text/css">

		<link href="../../assets/toasts.css" rel="stylesheet" type="text/css">
		<script src="../../assets/js/toasts.js"></script>

		<link rel="preconnect" href="https://api.tomatenkuchen.eu">
		<link rel="dns-prefetch" href="https://api.tomatenkuchen.eu">

		<script src="../../assets/js/script.js"></script>
		<script src="../../assets/js/language.js"></script>

		<script src="../../assets/js/sockette.js"></script>
		<script src="../../assets/js/api/transformer_dashboard.js"></script>

		<script>
			const userList = (user, canDelete = false) => "<li><img src='" + user.avatar + "?size=32' width='32' height='32' alt='User avatar of " + encode(user.username) + "'>" +
				encode(user.username) + (canDelete ? "<ion-icon name='trash-outline' onclick='removeUser(\"" + user.id + "\")'></ion-icon>" : "") + "</li>";
			let socket;
			let errorToast;
			let info = {};
			let step = 1;

			function connectWS() {
				socket = sockette("wss://api.tomatenkuchen.eu/user", {
					onClose: event => {
						errorToast = new ToastNotification({type: "ERROR", title: "Lost connection, retrying...", timeout: 30}).show();
					},
					onOpen: event => {
						console.log("Connected!", event);
						if (errorToast) {
							errorToast.setType("SUCCESS");
							setTimeout(() => {
								errorToast.close();
							}, 1000);
						}
						socket.send({
							status: "success",
							action: "GET_custom",
							token: getCookie("token")
						});
					},
					onMessage: event => {
						let json;
						try {
							json = JSON.parse(event.data);
						} catch (e) {
							console.warn(e, event);
							return socket.send({
								status: "error",
								message: "Invalid json",
								debug: event.data
							});
						}
						console.log(json);

						if (json.action == "NOTIFY") new ToastNotification(json).show();
						else if (json.action == "ADDED_custom_paying") {
							if (json.status == "failed") new ToastNotification({type: "ERROR", title: json.message || "Unknown user!"}).show();
							else document.getElementById("bot-paying").innerHTML = "<ul>" + json.paying.map(u => userList(u, true)).join("") + "</ul>" + (json.payingInvited.length > 0 ?
								"<p>Will be invited:<ul>" + json.payingInvited.map(u => userList(u, true)).join("") + "</ul>": "");
						} else if (json.action == "RECEIVE_custom") {
							document.getElementById("root-container").innerHTML = getCustomHTML(json);
							reloadText();
						} else if (json.action == "RECEIVE_custom_info") {
							info = json;
							if (json.status == "success") {
								document.getElementById("bot-data").removeAttribute("hidden");
								document.getElementById("forward-button").removeAttribute("disabled");

								document.getElementById("bot-name").textContent = encode(json.username);
								document.getElementById("bot-invite").href = "https://discord.com/oauth2/authorize?client_id=" + json.id + "&scope=bot&permissions=1393602981110";
								document.getElementById("bot-avatar").src = encode(json.avatar) + "?size=128";
								document.getElementById("bot-access").innerHTML = json.access.map(userList).join("");
								document.getElementById("bot-paying").innerHTML = "<ul>" + json.paying.map(u => userList(u, true)).join("") + "</ul>" + (json.payingInvited.length > 0 ?
									"<p>Will be invited:<ul>" + json.payingInvited.map(u => userList(u, true)).join("") + "</ul>": "");
								document.getElementById("bot-todo").innerHTML = json.todo.map(i => "<li>" + i + "</li>").join("");
							} else {
								tokenElem.setCustomValidity("Invalid bot" + (info.message ? ": " + info.message : " token."));
								tokenElem.reportValidity();
							}
						}
					}
				});
			}
		</script>
	</head>
	<body class="dark-theme" onload="pageLoad()">
		<global-sidebar page="dashboard"></global-sidebar>

		<main class="main" id="main">
			<header class="top">
				<div class="hamburger" onclick="sidebar()">
					<div class="line" id="lineTop1"></div>
					<div class="line" id="lineBottom1"></div>
				</div>

				<div class="hoverdropdown">
					<div class="account" onclick="location='/login'">
						<p id="username-header" translation="global.account">Account</p>
						<ion-icon id="username-avatar" name="person-circle-outline"></ion-icon>
					</div>
					<div class="hoverdropdown-content">
						<a href="/login" translation="global.login"></a>
					</div>
				</div>
			</header>

			<div class="content" id="content">
				<div id="create-dialog" class="dialog">
					<div class="dialog-content">
						<span class="close">&times;</span>
						<h1>Create a new custom branded bot</h1>

						<div id="bot-data" class="custom" hidden>
							<br>
							<div class="flex">
								<img id="bot-avatar" width="128" height="128" alt="Bot avatar">
								<h2 id="bot-name"></h2>
							</div>
							<br>
						</div>

						<div id="step1">
							<label for="custom-token">Your bot token</label>
							<input type="text" minlength="45" maxlength="90" pattern="[a-zA-Z0-9]{20,}\.[a-zA-Z0-9]{5,}\.[a-zA-Z0-9]{25,}" placeholder="Bot token from Discord" onchange="tokenChange()" name="custom-token" id="custom-token">
						</div>

						<div id="step2" hidden>
							<h2>Confirm users who have access to the bot</h2>
							<p>The following users have access to the bot and can manage it anytime in the Discord developer dashboard or on this page.</p>
							<ul id="bot-access"></ul>
						</div>

						<div id="step3" hidden>
							<h2>Select users who pay for the bot</h2>
							<p id="bot-payingdesc">
								A list of users who invest their vote credits into this custom bot. This setting allows you to allow your servers members to also vote for the bot to maintain it
								without giving them access to the bot in the dashboard.

								Every time a credits payment is due, the bot will <i>randomly</i> select a user from this list who has enough credits.
								If none of them has enough, the bot will send a warning and disable itself some time later (TBD).
							</p>

							<input placeholder="User ID" pattern="[0-9]{17,21}" onchange="addUser()" aria-describedby="bot-payingdesc" id="custom-invite">
							<br>
							<div id="bot-paying"></div>
						</div>

						<div id="step4" hidden>
							<h2>Remaining TODO list</h2>
							<button type="button" class="createForm" onclick="refresh()">Refresh</button>
							<ul id="bot-todo"></ul>
						</div>

						<div id="step5" hidden>
							<h2>You're done!</h2>
							<p>Click the button below to create the bot internally.</p>

							<br>
							<h3>Haven't invited the bot yet?</h3>
							<a id="bot-invite" target="_blank" rel="noopener">Click here to invite your bot to a server</a>
						</div>

						<br>
						<button type="button" id="back-button" class="createForm" onclick="back()" hidden>Back</button>
						<button type="button" id="forward-button" class="createForm green" onclick="forward()" disabled>Next</button>
					</div>
				</div>

				<div id="root-container" class="row">
					<h1>Loading your custom branded bots...</h1>
				</div>
			</div>
		</main>

		<script>
			const tokenElem = document.getElementById("custom-token");
			const refresh = save => socket.send({action: "GET_custom_info", botToken: tokenElem.value, save});

			function tokenChange() {
				step = 1;
				document.getElementById("bot-data").setAttribute("hidden", "");
				document.getElementById("back-button").setAttribute("hidden", "");
				document.getElementById("forward-button").setAttribute("disabled", "");

				const value = tokenElem.value;
				if (/[a-z0-9]{20,}\.[a-z0-9]{5,}\.[a-z0-9]{25,}/i.test(value) && value.length <= 90) refresh();
			}

			function addUser() {
				socket.send({action: "ADD_custom_paying", botToken: tokenElem.value, user: document.getElementById("custom-invite").value})
				document.getElementById("custom-invite").value = "";
			}
			function removeUser(user) {
				socket.send({action: "REMOVE_custom_paying", botToken: tokenElem.value, user})
			}

			function back() {
				if (step <= 1) return;
				document.getElementById("step" + step).setAttribute("hidden", "");
				step--;
				if (step == 4 && info.todo.length == 0) step--;
				document.getElementById("step" + step).removeAttribute("hidden");

				if (step == 1) document.getElementById("back-button").setAttribute("hidden", "");
				document.getElementById("forward-button").removeAttribute("hidden");
			}
			function forward() {
				document.getElementById("step" + step).setAttribute("hidden", "");
				step++;
				if (step == 4 && info.todo.length == 0) step++;
				document.getElementById("step" + step).removeAttribute("hidden");

				if (step == 5) {
					document.getElementById("forward-button").textContent = "Create bot";
					document.getElementById("forward-button").onclick = () => refresh(true);
				} else {
					document.getElementById("forward-button").textContent = "Next";
					document.getElementById("forward-button").onclick = forward;
				}
				document.getElementById("back-button").removeAttribute("hidden");
			}

			function createDialog() {
				step = 2;
				back();
				openDialog(document.getElementById("create-dialog"));
				document.getElementById("custom-token").value = "";
			}

			if (getCookie("token")) connectWS();
			else {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to login...</h1>";
				location.href = "../../login/?next=" + encodeURIComponent(location.pathname + location.search);
			}
		</script>

		<global-footer></global-footer>
		<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" integrity="sha384-xyQ/Vpt1cq1pdPYlRaT/QkcSj2vrYyWI3WOhxGBzqnP1vgvsS2yrhWXe3/wIoCr5" crossorigin="anonymous"></script>
	</body>
</html>
