<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="TomatenKuchen - Dein Discord Bot"/>

  <title>TomatenKuchen - Dashboard</title>
  <link rel="shortcut icon" type="image/x-icon" href="../assets/images/icon.ico"/>
  <link rel="icon" type="image/x-icon" href="../assets/images/icon.ico"/>

  <link rel="stylesheet" type="text/css" href="../assets/css/dark.css"/>

  <script type="text/javascript" src="../assets/js/script.js"></script>
  <script type="text/javascript" src="../assets/js/cookie.js"></script>
  <script type="text/javascript" src="../assets/js/api/api.js"></script>
  <script type="text/javascript" src="../assets/js/api/transformer.js"></script>
</head>

<body>
<div id="root-container">
  <header id="top">
    <a href=".." class="logo">TomatenKuchen<span>.</span></a>
    <div class="menu-toggle" onclick="toggleMenu();"></div>

    <ul class="navigation">
      <li><a href="..">Home</a></li>
      <li><a href="../commands">Befehle</a></li>
      <li><a href="../invite">Einladung</a></li>
      <li><a href="../docs">Dokumentation</a></li>
      <li class="active"><a href="#top">Dashboard</a></li>
    </ul>
  </header>

  <section class="banner">
    <div class="content">
      <h2>TomatenKuchen</h2>
      <a href="#guilds" class="button">Deine Server</a>
    </div>
  </section>

  <section id="guilds">
    <div class="row">
      <div class="col50" id="guilds-container">
        <h1>Die Server werden geladen...</h1>
      </div>
    </div>
  </section>
</div>

<script type="text/javascript">
  const params = new URLSearchParams(window.location.search);
  let saving = false;

  function saveSettings() {
    if (!params.has('guild')) return;
    if (saving) return;

    saving = true;
    const settings = document.getElementsByClassName('setting');

    let items = '?';
    for (let i = 0; i < settings.length; i++) {
      const item = settings.item(i);
      const entry = encodeURIComponent(item.name) + '=' + encodeURIComponent(item.value);

      if (i !== settings.length - 1) {
        items += entry + '&';
      } else {
        items += entry;
      }
    }

    document.getElementById('root-container').innerHTML = '<h1>Die Einstellungen werden gespeichert...</h1>';
    setSettings(params.get('guild'), items)
      .then((json) => {
        const timeout = 5;

        if (json.status === 'success') {
          document.getElementById('root-container').innerHTML = '' +
            '<h1>Die Einstellungen wurden erfolgreich aktualisiert!</h1>' +
            '<h1>In ' + timeout + ' Sekunden werden die Einstellungen wieder angezeigt.</h1>';
        } else {
          document.getElementById('root-container').innerHTML = '' +
            '<h1>Es gab einen Fehler beim Verarbeiten der API-Abfrage!</h1>' +
            '<h1>' + json.message + '</h1>' +
            '<h1>In ' + timeout + ' Sekunden werden die Einstellungen wieder angezeigt.</h1>';
        }

        setTimeout(() => {
          location.reload();
        }, 1000 * timeout);

        saving = false;
      })
  }

  if (params.has('code')) {
    document.head.innerHTML = document.head.innerHTML.replace('dark.css', 'simple.css');
    document.getElementById('root-container').innerHTML = '<h1>Die Anmeldung erfolgt, bitte warten...</h1>';

    login(params.get('code'))
      .then((json) => {
        if (json.status === 'success') {
          setCookie('token', json.token);

          let query = '';
          if (params.has('guild')) {
            query = '?guild=' + params.get('guild');
          }

          location.href = 'https://' + location.host + '/dashboard' + query;
        } else {
          document.getElementById('root-container').innerHTML = '' +
            '<h1>Es gab einen Fehler beim Verarbeiten der API-Abfrage!</h1>' +
            '<h1>' + json.message + '</h1>';
        }
      })
  } else if (!getCookie('token')) {
    document.head.innerHTML = document.head.innerHTML.replace('dark.css', 'simple.css');
    document.getElementById('root-container').innerHTML = '<h1>Es wird zur Anmeldung weitergeleitet...</h1>';

    location.href = '../login';
  } else if (params.has('guild')) {
    const guild = params.get('guild');

    document.head.innerHTML = document.head.innerHTML.replace('dark.css', 'simple.css');
    document.getElementById('root-container').innerHTML = '<h1>Die Einstellungen werden geladen...</h1>';

    getSettingsHTML(guild)
      .then((html) => {
        document.getElementById('root-container').innerHTML = html;
      });
  } else {
    getGuildsHTML()
      .then((html) => {
        document.getElementById('guilds-container').innerHTML = html;
      });
  }
</script>
</body>
</html>
