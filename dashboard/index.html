<!DOCTYPE html>
<html lang="de">
<head>
  <title>TomatenKuchen - Dashboard</title>
  <meta charset="UTF-8">

  <link rel="shortcut icon" type="image/x-icon" href="../assets/icon.ico"/>
  <link rel="icon" type="image/x-icon" href="../assets/icon.ico"/>

  <link rel="stylesheet" type="text/css" href="../assets/css/commands.css"/>

  <script type="text/javascript" src="../assets/js/cookie.js"></script>
  <script type="text/javascript" src="../assets/js/api/api.js"></script>
  <script type="text/javascript" src="../assets/js/api/transformer.js"></script>
</head>

<body>
<div id="root-container">
  <header>
    <a href=".." class="logo">
      TomatenKuchen<span>.</span>
    </a>
  </header>

  <section class="banner" id="banner">
    <div class="content">
      <h2>TomatenKuchen</h2>
      <p>Deine Server</p>

      <a href="#guilds" class="btn">
        Server
      </a>
    </div>
  </section>

  <section id="guilds">
    <div class="row">
      <div class="col50">
        <h1 id="guilds-container">Loading...</h1>
      </div>
    </div>
  </section>
</div>

<script type="text/javascript">
  const params = new URLSearchParams(window.location.search);
  let saving = false;

  function saveSettings() {
    if (!params.has('guild')) return;
    if (saving) return;

    saving = true;
    const settings = document.getElementsByClassName('setting');
    document.getElementById('root-container').innerHTML = '<h1>Saving settings, please wait...</h1>';

    let items = '';
    for (let i = 0; i < settings.length; i++) {
      const item = settings.item(i);
      const entry = encodeURIComponent(item.name) + '=' + encodeURIComponent(item.value);

      if (i !== settings.length - 1) {
        items += entry + ',';
      } else {
        items += entry;
      }
    }

    setSettings(params.get('guild'), items)
      .then((json) => {
        if (json.status === 'success') {
          document.getElementById('root-container').innerHTML = '' +
            '<h1>Die Einstellungen wurden erfolgreich aktualisiert!</h1>' +
            '<h1>The page will return to the settings in 5 seconds.</h1>';
        } else {
          document.getElementById('root-container').innerHTML = '' +
            '<h1>There was an error while processing the api request!</h1>' +
            '<h1>The page will return to the settings in 5 seconds.</h1>' +
            '<h1>' + json.message + '</h1>';
        }

        setTimeout(() => {
          location.reload();
        }, 5000);

        saving = false;
      })
  }

  if (params.has('code')) {
    document.head.innerHTML = document.head.innerHTML.replace('commands.css', 'style.css');
    document.getElementById('root-container').innerHTML = '<h1>Logging in, please wait...</h1>';

    login(params.get('code'))
      .then((json) => {
        if (json.status === 'success') {
          setCookie('token', json.token);

          let query = '';
          if (params.has('guild')) {
            query = '?guild=' + params.get('guild');
          }

          location.href = 'https://' + location.host + '/dashboard' + query;
        } else {
          document.getElementById('root-container').innerHTML = '' +
            '<h1>There was an error while processing the api request!</h1>' +
            '<h1>' + json.message + '</h1>';
        }
      })
  } else if (!getCookie('token')) {
    document.head.innerHTML = document.head.innerHTML.replace('commands.css', 'style.css');
    document.getElementById('root-container').innerHTML = '<h1>Redirecting to login form...</h1>';

    location.href = '../login';
  } else if (params.has('guild')) {
    const guild = params.get('guild');

    document.head.innerHTML = document.head.innerHTML.replace('commands.css', 'style.css');
    document.getElementById('root-container').innerHTML = '<h1>Loading Settings, please wait...</h1>';

    getSettingsHTML(guild)
      .then((html) => {
        document.getElementById('root-container').innerHTML = html;
      });
  } else {
    getGuildsHTML()
      .then((html) => {
        document.getElementById('guilds-container').parentElement.innerHTML = html;
      });
  }
</script>
</body>
</html>
