<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="Multipurpose multilanguage Discord bot with many features for your Discord server, like unlimited and feature rich integrations for e.g. customcommands.">
		<meta name="theme-color" content="#ed8721">

		<link rel="alternate" hreflang="de-DE" href="https://tomatenkuchen.eu/dashboard/integrations/">
		<link rel="canonical" href="https://tomatenkuchen.eu/dashboard/integrations/">
		<link rel="manifest" href="../../manifest.json">

		<title>TomatenKuchen - Integrations - Dashboard</title>
		<link href="../../assets/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
		<link href="../../assets/images/apple-icon-120.png" rel="apple-touch-icon" sizes="120x120">
		<link href="../../assets/images/apple-icon-152.png" rel="apple-touch-icon" sizes="152x152">

		<link href="../../assets/style.css" rel="stylesheet" type="text/css">

		<link href="../../assets/toasts.css" rel="stylesheet" type="text/css">
		<script src="../../assets/js/toasts.js"></script>

		<link rel="preconnect" href="https://api.tomatenkuchen.eu">
		<link rel="dns-prefetch" href="https://api.tomatenkuchen.eu">

		<script src="../../assets/js/script.js"></script>
		<script src="../../assets/js/language.js"></script>

		<script src="../../assets/js/sockette.js"></script>
		<script src="../../assets/js/api/transformer_dashboard.js"></script>

		<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@%5E1/index.js" integrity="sha384-K6agUzbeMc1GXMXkIluupxooxm0lI/miwK1KgDxZqBS19dXN9xTv3eEg8qOjpQ2q" crossorigin="anonymous"></script>
		<script src="../../assets/js/emojipicker.js"></script>
		<link href="../../assets/emojipicker.css" rel="stylesheet" type="text/css">

		<script>
			function handleChange() {}

			function createDialog() {
				document.getElementById("actions-container").innerHTML = "";
				document.getElementById("create-dialog").removeAttribute("data-edit");
				document.getElementById("integration-name").value = "";
				document.getElementById("integration-name").removeAttribute("readonly");
				document.getElementById("integration-short").value = "";
				document.getElementById("integration-long").value = "";
				document.getElementById("integration-public").checked = true;
				document.getElementById("integration-placeholders").value = "";
				document.getElementById("integration-input").value = "";
				document.getElementById("integration-env").value = "";
				document.getElementById("integration-submit").innerText = "Create integration";

				addAction(document.getElementById("integration-addaction"));
				openDialog(document.getElementById("create-dialog"));
			}

			function addAction(clickedElem) {
				const newElem = document.getElementById("actions-template").content.cloneNode(true);
				newElem.id = "actions-" + Math.random().toString(36).slice(2);
				const wrapper = document.createElement("div");
				wrapper.classList.add("action");
				wrapper.appendChild(newElem);
				document.getElementById("actions-container").appendChild(wrapper);

				const elem = wrapper.querySelector("channel-picker .picker div[data-id='command']");
				elem.classList.add("selected");
				wrapper.querySelector("channel-picker .list").innerHTML += "<div>" + elem.innerHTML + "</div>";
				wrapper.querySelector("channel-picker").setAttribute("data-selected", elem.getAttribute("data-id"));
			}

			let guildName = "";
			let integrations = [];
			function integrationInfo(integrationName) {
				openDialog(document.getElementById("info-dialog"));
				const integration = integrations.find(e => e.name == integrationName);

				document.getElementById("info-container").innerHTML =
					"<h1><span translation='integration.infotitle'></span> <b>" + encode(integrationName) + "</b></h1>" + (integration.verified ? " <ion-icon name='checkmark-circle-outline'></ion-icon>" : "") +
					"<h2>" + encode(integration.short) + "</h2><br>" +
					"<p>" + encode(integration.long) + "</p><br>" +
					"<p><span translation='integration.owner'></span> <b>" + encode(integration.owner) + "</b></p>" +
					"<p><span translation='integration.public'></span>: " + (integration.public ? "✅" : "❌") + "</p>" +
					"<p><span translation='integration.usedby'></span> <b>" + encode("" + integration.uses) + "</b></p>" +
					"<p><span translation='integration.version'></span>: <code>" + encode(integration.version) + "</code></p>" +
					"<p><span translation='tickets.created'></span>: " + new Date(integration.created).toLocaleString() + "</p>" +
					"<p><span translation='integration.lastupdate'></span> " + new Date(integration.lastUpdate).toLocaleString() + "</p><br><h2 translation='integration.actions'></h2>" +
					integration.actions.map(action => (
						"<p>Name: <b>" + encode(action.name) + "</b></p>" +
						"<p><span translation='integration.trigger'></span>: <code>" + encode(action.trigger) + "</code></p>" +
						(action.args && action.args[0] ? "<p>Args 1: " + encode(action.args[0]) + "</p>" : "") +
						"<textarea class='code' rows='" + (Math.round(action.content.split("\n").length * 1.2) + 2) + "' readonly>" + encode(action.content) + "</textarea>"
					)).join("<br><br>") +
					(integration.guild == params.get("guild") ? "" : "<br><br><button type='button' class='createForm red' onclick='integrationUse(\"" + encode(integrationName) + "\")'><span translation='integration.use'></span> <b>" + encode(guildName) + "</b></button>");
				reloadText();
			}
			function integrationUse(integrationName) {
				document.getElementById("info-dialog").style.display = "none";
				openDialog(document.getElementById("create-dialog"));
				const integration = integrations.find(e => e.name == integrationName);

				document.getElementById("create-title").innerHTML = "<span translation='integration.createsource'></span> <b>" + encode(integration.name) + "</b>";
				document.getElementById("integration-name").value = encode(integration.name);
				document.getElementById("integration-use-container").removeAttribute("hidden");
				document.getElementById("integration-submit").onclick = () => createIntegration(integrationName);
				document.getElementById("integration-use-placeholders").innerHTML = integration.placeholders ? integration.placeholders.map(e => "<code>" + encode(e) + "</code>").join("<br>") : "";
				document.getElementById("integration-use-input").innerHTML = integration.input ? integration.input.map(e => {
					const randomId = Math.random().toString(36).slice(2);
					return "<label for='" + randomId + "'>" + encode(e.split(";")[1]) + "</label>" +
						"<input type='text' maxlength='200' placeholder='" + (encode(e.split(";")[2]) || "") + "' id='" + randomId + "' name='" + encode(e.split(";")[0]) + "'>"
				}).join("<br>") : "";

				document.getElementById("actions-container").innerHTML = "";
				integration.actions.forEach(action => {
					const newElem = document.getElementById("actions-template").cloneNode(true);
					newElem.querySelector(".action-args1").value = action.args[0] || "";
					newElem.querySelector(".action-content").value = action.content;
					newElem.querySelector(".action-content").rows = Math.round(action.content.split("\n").length * 1.2) + 2;
					if (document.getElementById("integration-sync").getAttribute("data-selected") == "auto" || document.getElementById("integration-sync").getAttribute("data-selected") == "safe")
						newElem.querySelector(".action-content").setAttribute("readonly", "");
				});
				reloadText();
			}

			function integrationEdit(integrationName) {
				openDialog(document.getElementById("create-dialog"));
				const integration = integrations.find(e => e.name == integrationName);

				document.getElementById("create-dialog").setAttribute("data-edit", "");
				document.getElementById("create-title").innerHTML = "<span translation='integration.edittitle'></span> <b>" + encode(integrationName) + "</b>";
				document.getElementById("integration-name").value = integrationName;
				document.getElementById("integration-name").setAttribute("readonly", "");
				document.getElementById("integration-short").value = integration.short;
				document.getElementById("integration-long").value = integration.long || "";
				document.getElementById("integration-public").checked = integration.public;
				integration.actions.forEach(action => {
					const newElem = document.getElementById("actions-template").cloneNode(true);
					newElem.querySelector(".action-args1").value = action.args && action.args[0] ? action.args[0] : "";
					newElem.querySelector(".action-content").value = action.content;
					newElem.querySelector(".action-content").rows = Math.round(action.content.split("\n").length * 1.2) + 2;

					const elem = newElem.querySelector(".action-trigger .picker div[data-id='" + item[1] + "']");
					elem.classList.add("selected");
					newElem.querySelector(".action-trigger .list").innerHTML += "<div>" + elem.innerHTML + "</div>";
					newElem.querySelector(".action-trigger").setAttribute("data-selected", elem.getAttribute("data-id"));
				});
				document.getElementById("integration-placeholders").value = (integration.input || integration.placeholders ? "<h2>User input variables</h2>" : "") + integration.placeholders ? "Available placeholders:<br>" + integration.placeholders.join("\n") : "";
				document.getElementById("integration-placeholders").rows = (integration.placeholders ? integration.placeholders.length : 0) + 2;
				document.getElementById("integration-input").value = integration.input ? integration.input.join("\n") : "";
				document.getElementById("integration-input").rows = (integration.input ? integration.input.length : 0) + 2;
				document.getElementById("integration-env").value = integration.env ? integration.env.join("\n") : "";
				document.getElementById("integration-env").rows = (integration.env ? integration.env.length : 0) + 2;
				document.getElementById("integration-submit").innerText = "<span translation='integration.edit'></span>";
			}

			let socket;
			function deleteIntegration(elem, integration = "") {
				const confirmed = confirm("Are you sure you want to delete this integration? This cannot be undone!");
				if (confirmed) {
					elem.parentElement.remove();
					socket.send(JSON.stringify({status: "success", action: "DELETE_integration", name: integration}));
				}
			}

			function handleIntegration(integration) {
				return "<div class='integration'>" +
					"<div class='flex'>" +
						(integration.image ? "<img src='" + encode(integration.image) + "' alt='Integration image of " + encode(integration.name) + "' width='120' loading='lazy'>" : "") +
						"<h2>" + encode(integration.name) + "</h2>" + (integration.verified ? " <ion-icon name='checkmark-circle-outline'></ion-icon>" : "") +
					"</div>" +
					"<p><span translation='integration.owner'></span> " + encode(integration.owner) + "</p>" +
					"<p><span translation='integration.public'></span>: " + (integration.public ? "✅" : "❌") + "</p>" +
					"<p><span translation='integration.lastupdate'></span> " + new Date(integration.lastUpdate).toLocaleDateString() + "</p>" +
					"<div class='flex'>" +
						"<button onclick='integrationInfo(\"" + encode(integration.name) + "\")' translation='integration.viewuse'></button>" +
						(integration.isOwner ? "<button onclick='integrationEdit(\"" + encode(integration.name) + "\")'><span translation='integration.edit'></span> <ion-icon name='build-outline'></ion-icon></button>" : "") +
						(integration.isOwner ? "<button onclick='deleteIntegration(this, \"" + encode(integration.name) + "\")'><ion-icon name='trash-outline'></ion-icon></button>" : "") +
					"</div>" +
					"</div>";
			}

			let pickerData = {};
			function connectWS(guild) {
				socket = sockette("wss://api.tomatenkuchen.eu", {
					onClose: event => {
						errorToast = new ToastNotification({type: "ERROR", title: "Lost connection, retrying...", timeout: 30}).show();
					},
					onOpen: event => {
						console.log("Connected!", event);
						if (errorToast) {
							errorToast.setType("SUCCESS");
							setTimeout(() => {
								errorToast.close();
							}, 1000);
						}
						socket.send({
							status: "success",
							action: "GET_integrations",
							guild,
							lang: getLanguage(),
							token: getCookie("token")
						});
						socket.send({
							status: "success",
							action: "GET_emojis",
							guild,
							token: getCookie("token")
						});
					},
					onMessage: event => {
						let json;
						try {
							json = JSON.parse(event.data);
						} catch (e) {
							console.warn(e, event);
							return socket.send({
								status: "error",
								message: "Invalid json",
								debug: event.data
							});
						}
						console.log(json);

						if (json.action == "NOTIFY") new ToastNotification(json).show();
						else if (json.action == "RECEIVE_integrations") {
							document.getElementById("linksidebar").innerHTML =
								"<a href='/' title='Home' class='tab'>" +
									"<ion-icon name='home-outline'></ion-icon>" +
									"<p translation='sidebar.home'></p>" +
								"</a>" +
								"<a href='/commands/' title='Bot commands' class='tab'>" +
									"<ion-icon name='terminal-outline'></ion-icon>" +
									"<p translation='sidebar.commands'></p>" +
								"</a>" +
								"<a href='/dashboard/' class='tab active'>" +
									"<ion-icon name='settings-outline'></ion-icon>" +
									"<p translation='sidebar.dashboard'></p>" +
								"</a>" +
								"<div class='section middle'><p class='title' translation='dashboard.settings'></p>" +
									"<a class='tab otherlinks' href='../settings/?guild=" + guild + "'><ion-icon name='settings-outline'></ion-icon><p translation='dashboard.settings'>Settings</p></a>" +
									"<div class='tab otherlinks active'><ion-icon name='terminal-outline'></ion-icon><p translation='dashboard.integrations'>Integrations</p></div>" +
									"<a class='tab otherlinks' href='../customcommands/?guild=" + guild + "'><ion-icon name='terminal-outline'></ion-icon><p>Customcommands</p></a>" +
									"<a class='tab otherlinks' href='../reactionroles/?guild=" + guild + "'><ion-icon name='happy-outline'></ion-icon><p>Reactionroles</p></a>" +
									"<a class='tab otherlinks' href='../../leaderboard/?guild=" + guild + "'><ion-icon name='speedometer-outline'></ion-icon><p translation='dashboard.leaderboard'>Leaderboard</p></a>" +
									"<a class='tab otherlinks' href='../../stats/?guild=" + guild + "'><ion-icon name='bar-chart-outline'></ion-icon><p translation='dashboard.stats'>Statistics</p></a>" +
								"</div></div>";

							document.getElementById("root-container").innerHTML = getIntegrationsHTML(json, guild);
							reloadText();
							guildName = json.name;
							integrations = json.integrations;

							pickerData = {
								...pickerData,
								"integration-sync": json.sync,
								"integration-version": json.versions,
								"action-trigger": json.triggers
							};

							[["integration-sync", "safe"], ["integration-version", "1.0.0"]].forEach(item => {
								const pickerNode = document.createElement("channel-picker");
								pickerNode.setAttribute("id", item[0]);
								pickerNode.setAttribute("type", item[0]);
								pickerNode.setAttribute("tabindex", "0");
								document.querySelector("label[for='" + item[0] + "']").parentNode.insertBefore(pickerNode, document.querySelector("label[for='" + item[0] + "']").nextSibling);

								const elem = document.querySelector("#" + item[0] + " .picker div[data-id='" + item[1] + "']");
								elem.classList.add("selected");
								document.querySelector("#" + item[0] + " .list").innerHTML += "<div>" + elem.innerHTML + "</div>";
								document.getElementById(item[0]).setAttribute("data-selected", elem.getAttribute("data-id"));
							});
						} else if (json.action == "SAVED_integration") {
							saving = false;
							savingToast.setType("SUCCESS").setTitle("The integration was saved!");
						} else if (json.action == "RECEIVE_emojis") {
							pickerData = {
								...pickerData,
								emojis: json.emojis,
								roles: json.roles
							};
						}
					}
				});
			}
		</script>
	</head>
	<body class="dark-theme" onload="pageLoad()">
		<global-sidebar page="dashboard"></global-sidebar>

		<main class="main" id="main">
			<header class="top">
				<div class="hamburger" onclick="sidebar()">
					<div class="line" id="lineTop1"></div>
					<div class="line" id="lineBottom1"></div>
				</div>

				<div class="hoverdropdown">
					<div class="account" onclick="location = '/login/'">
						<p id="username-header" translation="global.account">Account</p>
						<ion-icon id="username-avatar" name="person-circle-outline"></ion-icon>
					</div>
					<div class="hoverdropdown-content">
						<a href="/login/" translation="global.login"></a>
					</div>
				</div>
			</header>

			<div class="content" id="content">
				<div id="create-dialog" class="dialog">
					<div class="dialog-content">
						<span class="close">&times;</span>
						<h1 id="create-title" translation="integration.create"></h1>

						<label for="integration-name">Unique name</label>
						<input type="text" maxlength="32" pattern="[a-z0-9_\-]+" placeholder="Display name" name="integration-name" id="integration-name">

						<div id="integration-use-container" hidden>
							<label for="integration-sync" translation="integration.syncmode"></label>

							<p id="integration-use-placeholders"></p>
							<div id="integration-use-input"></div>
						</div>

						<label for="integration-short" translation="integration.shortdesc"></label>
						<input type="text" maxlength="200" placeholder="Short description" name="integration-short" id="integration-short">

						<label for="integration-public" translation="integration.public"></label>
						<input type="checkbox" name="integration-public" id="integration-public" checked>

						<label for="integration-version" translation="integration.version"></label>

						<button type="button" id="integration-addaction" class="createForm" onclick="addAction(this)" translation="integration.addaction"></button>
						<template id="actions-template">
							<label for="action-name">Action name</label>
							<input type="text" maxlength="32" pattern="[a-z0-9_\-]+" placeholder="Slash/message command name" name="action-name" class="action-name">

							<label for="action-trigger" translation="integration.trigger"></label>
							<channel-picker class="action-trigger" type="action-trigger" name="action-trigger" tabindex="0"></channel-picker>

							<label for="action-args1">If command: Slash command description, if regex: RegExp</label>
							<input type="text" maxlength="100" placeholder="Variable input" name="action-args1" class="action-args1" title="If the trigger type is command, filling this out will create a slash command for it with the given description. Can be used as comment for non-commands.">

							<label for="action-content" translation="dashboard.content"></label>
							<div class="emoji-container emoji-special">
								<textarea class="code action-content" maxlength="2000" placeholder="Action content" name="action-content" rows="8"></textarea>
								<ion-icon name="at-outline" title="Rolepicker" onclick="mentionPicker(this.parentElement, pickerData.roles)"></ion-icon>
								<ion-icon name="happy-outline" title="Emojipicker" onclick="emojiPicker(this.parentElement, pickerData.emojis, guildName)"></ion-icon>
							</div>
						</template>
						<div id="actions-container"></div>
						<button type="button" class="createForm" onclick="addAction(this)" translation="integration.addaction"></button>

						<br>
						<br>
						<details>
							<summary translation="integration.additionalpublic"></summary>
							<label for="integration-long" translation="integration.longdesc"></label>
							<textarea class="setting" maxlength="1000" placeholder="Long description" name="integration-long" id="integration-long" rows="7"></textarea>

							<label for="integration-image" translation="integration.imageurl"></label>
							<input type="text" maxlength="300" placeholder="Image URL" name="integration-image" id="integration-image">

							<label for="integration-placeholders">Placeholder text, one per line</label>
							<textarea class="code" maxlength="300" placeholder="Placeholders" name="integration-placeholders" id="integration-placeholders" rows="2"></textarea>

							<label for="integration-input">Input variables, one per line</label>
							<textarea class="code" maxlength="300" placeholder="url;Your GitHub URL;https://github.com/DEVTomatoCake" name="integration-input" id="integration-input" rows="2"></textarea>

							<label for="integration-env">Environment variables, one per line, hidden for other users</label>
							<textarea class="code" maxlength="300" placeholder="apikey;your-secret-api-key" name="integration-env" id="integration-env" rows="2"></textarea>
						</details>
						<br>

						<button type="submit" id="integration-submit" class="createForm" onclick="createIntegration()" translation="integration.create"></button>
					</div>
				</div>

				<div id="info-dialog" class="dialog">
					<div class="dialog-content">
						<span class="close">&times;</span>
						<div id="info-container"></div>
					</div>
				</div>

				<div id="root-container" class="row"></div>
			</div>
		</main>

		<script>
			const params = new URLSearchParams(location.search);
			let saving = false;
			let savingToast;
			let errorToast;

			function createIntegration(sourceId = "") {
				if (!params.has("guild") || saving) return;
				saving = true;

				const name = encode(document.getElementById("integration-name").value);
				if (!name) return alert("Enter a name for the integration!");
				if (!/^[a-z0-9_-]+$/g.test(name)) return alert("The name can only contain lowercase letters, numbers, underscores and dashes!");
				if (name.length > 32) return alert("The name can be at most 32 characters long!");

				document.getElementById("create-dialog").style.display = "none";
				if (document.getElementById("no-integrations")) document.getElementById("no-integrations").remove();

				const data = {
					edit: document.getElementById("create-dialog").hasAttribute("data-edit"),
					guild: params.get("guild"),
					owner: getCookie("user") || "You",
					isOwner: true,
					created: Date.now(),
					lastUpdate: Date.now(),
					name,
					short: document.getElementById("integration-short").value,
					long: document.getElementById("integration-long").value,
					image: document.getElementById("integration-image").value,
					public: document.getElementById("integration-public").checked,
					version: document.getElementById("integration-version").getAttribute("data-selected"),
					actions: [],
					placeholders: document.getElementById("integration-placeholders").value.split("\n").map(e => e.trim()).filter(e => e),
					input: document.getElementById("integration-input").value.split("\n").map(e => e.trim()).filter(e => e),
					env: document.getElementById("integration-env").value.split("\n").map(e => e.trim()).filter(e => e)
				};
				if (sourceId) {
					data.source = sourceId;
					data.sync = document.getElementById("integration-sync").getAttribute("data-selected");
				}
				integrations[name] = data;

				const actions = document.getElementById("actions-container").getElementsByClassName("action");
				for (let j = 0; j < actions.length; j++) {
					const action = actions.item(j);
					data.actions.push({
						name: action.querySelector(".action-name").value,
						args: action.querySelector(".action-args1").value ? [action.querySelector(".action-args1").value] : [],
						trigger: action.querySelector(".action-trigger").getAttribute("data-selected"),
						content: action.querySelector(".action-content").value
					});
				}

				const div = document.createElement("div");
				div.innerHTML = handleIntegration(data);
				document.getElementsByClassName("integration-container")[0].appendChild(div);
				reloadText();

				socket.send(JSON.stringify({
					status: "success",
					action: "SAVE_integration",
					data
				}));

				savingToast = new ToastNotification({type: "LOADING", title: "Saving integration \"" + encode(name) + "\"...", timeout: 7}).show();
			}

			if (params.has("guild") && getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Loading integrations...</h1>";
				connectWS(encode(params.get("guild")));
			} else if (params.has("guild_id") && getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Loading integrations...</h1>";
				location.href = "./?guild=" + params.get("guild_id");
			} else if (getCookie("token")) {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to server selection...</h1>";
				localStorage.setItem("next", location.pathname);
				location.href = "../";
			} else {
				document.getElementById("root-container").innerHTML = "<h1>Redirecting to login...</h1>";
				location.href = "../../login/?next=" + encodeURIComponent(location.pathname + location.search);
			}
		</script>

		<global-footer></global-footer>
		<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" integrity="sha384-xyQ/Vpt1cq1pdPYlRaT/QkcSj2vrYyWI3WOhxGBzqnP1vgvsS2yrhWXe3/wIoCr5" crossorigin="anonymous"></script>
	</body>
</html>
